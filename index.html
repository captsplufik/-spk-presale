<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPK Token Presale</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- TON Connect UI SDK -->
    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        /* Custom styles for Inter font and body background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            overflow-x: hidden; /* Prevent horizontal scroll */
            color: #e2e8f0; /* Light text for dark background */
        }

        /* Canvas styling for 3D background */
        #three-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Send to background */
            opacity: 0.15; /* Subtle opacity */
        }

        /* Custom animation for glow effect */
        @keyframes pulse-glow {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 5px rgba(147, 51, 234, 0.5));
            }
            50% {
                filter: brightness(1.2) drop-shadow(0 0 15px rgba(147, 51, 234, 0.8));
            }
        }
        .animate-pulse-glow {
            animation: pulse-glow 4s infinite ease-in-out;
        }

        /* Custom message box styles */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .message-box.hidden {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            pointer-events: none;
        }
        .message-box.success {
            background-color: #10b981; /* Emerald 500 */
            color: white;
        }
        .message-box.error {
            background-color: #ef4444; /* Red 500 */
            color: white;
        }
        .message-box.warning {
            background-color: #F59E0B; /* Amber 500 */
            color: white;
        }

        /* General fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        .delay-200 { animation-delay: 0.2s; }
        .delay-400 { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out forwards;
        }

        /* Responsive adjustments for the TON Connect button */
        #ton-connect-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            #ton-connect-button-wrapper {
                align-items: center;
                width: 100%;
            }
        }

        /* Presale specific styles */
        .presale-countdown-item {
            text-align: center;
        }

        .presale-countdown-item span {
            font-size: 42px;
            font-weight: 700;
            color: #9333ea; /* Primary purple */
        }

        .presale-countdown-item small {
            display: block;
            font-size: 14px;
            color: #94a3b8; /* Gray */
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .progress-bar-container {
            margin-bottom: 30px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 500;
            color: #e2e8f0;
        }

        .progress-bar {
            height: 10px;
            background: #4a5568; /* Darker gray for empty bar */
            border-radius: 10px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #9333ea, #ec4899); /* Purple to Pink gradient */
            border-radius: 10px;
            transition: width 1s ease;
        }

        .input-group {
            position: relative;
        }

        .input-group label {
            position: absolute;
            left: 15px;
            top: -10px;
            background: #1f2937; /* Dark gray for label background */
            padding: 0 10px;
            font-size: 14px;
            color: #9333ea; /* Primary purple */
            font-weight: 500;
            z-index: 1;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 1px solid #4a5568; /* Darker gray border */
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #2d3748; /* Even darker gray for input background */
            color: #e2e8f0;
        }

        .input-group input:focus {
            outline: none;
            border-color: #9333ea; /* Primary purple on focus */
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.2);
        }

        .token-price-display {
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            font-weight: 600;
            color: #e2e8f0;
        }

        .token-price-display span {
            color: #9333ea; /* Primary purple */
            font-size: 24px;
        }
        .transaction-status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            text-align: center;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .status-warning {
            background-color: #fbbf24; /* Amber 400 */
            color: #78350f; /* Amber 900 */
        }
        .status-success {
            background-color: #34d399; /* Green 400 */
            color: #065f46; /* Green 900 */
        }
        .status-error {
            background-color: #ef4444; /* Red 500 */
            color: #7f1d1d; /* Red 900 */
        }
    </style>
</head>
<body class="text-white flex flex-col min-h-screen">

    <!-- 3D Background Canvas -->
    <canvas id="three-bg"></canvas>

    <!-- Message Box Element -->
    <div id="messageBox" class="message-box hidden"></div>

    <!-- Navigation Bar -->
    <nav class="p-6 flex justify-between items-center z-10 bg-gray-900 bg-opacity-70 backdrop-blur-sm shadow-lg rounded-b-xl">
        <div class="flex items-center space-x-4">
            <a href="#" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 rounded-lg p-1">
                SPK
            </a>
            <ul class="hidden md:flex space-x-8 text-lg">
                <li><a href="#presale-section" class="hover:text-purple-400 transition-colors duration-300">Presale</a></li>
                <li><a href="#tokenomics" class="hover:text-purple-400 transition-colors duration-300">Tokenomics</a></li>
                <li><a href="#roadmap" class="hover:text-purple-400 transition-colors duration-300">Roadmap</a></li>
                <li><a href="https://docs.yourproject.com" target="_blank" rel="noopener noreferrer" class="hover:text-purple-400 transition-colors duration-300">Docs</a></li>
            </ul>
        </div>
        <div id="ton-connect-button-wrapper">
            <!-- TON Connect UI Button will be rendered here -->
            <div id="ton-connect"></div>
            <div id="wallet-status" class="text-gray-400 text-sm">Not Connected</div>
        </div>
    </nav>

    <!-- Main Content Area (Now starts with Presale Section) -->
    <main class="flex-grow flex items-center justify-center py-16 px-4 md:px-8 z-10">
        <section id="presale-section" class="max-w-3xl mx-auto bg-gray-800 bg-opacity-80 backdrop-blur-md p-8 md:p-12 rounded-3xl shadow-2xl border border-gray-700 text-center animate-fade-in-up">
            <h2 class="text-4xl md:text-5xl font-bold mb-12 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                SPK Token Presale
            </h2>

            <!-- Presale Countdown -->
            <div class="mb-10 p-6 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
                <h3 id="presale-countdown-title" class="text-2xl font-bold text-purple-300 mb-4">Presale Starts In:</h3>
                <div id="presale-countdown" class="text-4xl md:text-5xl font-mono font-extrabold text-green-400">
                    <span id="presale-days">00</span>d <span id="presale-hours">00</span>h <span id="presale-minutes">00</span>m <span id="presale-seconds">00</span>s
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-label">
                    <span>Raised: <strong id="raisedAmount">$20,000</strong></span>
                    <span>Target: <strong id="targetAmount">$5,000,000</strong></span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="presaleProgress" style="width: 25%;"></div>
                </div>
            </div>

            <!-- Purchase Form -->
            <div class="presale-form mt-8">
                <div class="input-group">
                    <label for="usdtAmount">USDT Amount</label>
                    <input type="number" id="usdtAmount" placeholder="10 to 1000 USDT" min="10" max="1000" class="w-full">
                </div>
                <button id="contribute-btn" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-75 mt-6" disabled>
                    <span id="contribute-btn-normal-state"><i class="fas fa-coins mr-2"></i> Buy SPK Tokens</span>
                    <span id="contribute-btn-processing-state" class="hidden">Processing... <i class="fas fa-spinner fa-spin ml-2"></i></span>
                </button>
                <div id="presale-transaction-status" class="mt-4"></div>
                <p class="token-price-display">1 USDT = <span id="spk-token-rate">200 SPK</span></p>

                <!-- Presale Claim Button -->
                <button id="claim-presale-tokens-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg shadow-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-75 mt-4" disabled>
                    Claim Presale Tokens
                </button>
                <div id="presale-claim-status" class="mt-4 text-green-400 font-semibold"></div>
            </div>
        </section>
    </main>

    <!-- Tokenomics Section -->
    <section id="tokenomics" class="py-20 px-4 bg-gray-950">
        <div class="max-w-6xl mx-auto text-center">
            <h2 class="text-4xl md:text-5xl font-bold mb-12 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">Tokenomics</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 hover:border-purple-500 transition-all duration-300 transform hover:-translate-y-2">
                    <h3 class="text-2xl font-semibold mb-4 text-purple-300"><i class="fas fa-coins mr-2"></i> Presale</h3>
                    <p class="text-gray-400">25% (500M SPK)<br>6mo cliff, 12mo vesting</p>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 hover:border-cyan-500 transition-all duration-300 transform hover:-translate-y-2">
                    <h3 class="text-2xl font-semibold mb-4 text-cyan-300"><i class="fas fa-lock mr-2"></i> Liquidity</h3>
                    <p class="text-gray-400">20% (400M SPK)<br>2 year lock</p>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 hover:border-pink-500 transition-all duration-300 transform hover:-translate-y-2">
                    <h3 class="text-2xl font-semibold mb-4 text-pink-300"><i class="fas fa-chart-line mr-2"></i> Staking</h3>
                    <p class="text-gray-400">15% (300M SPK)<br>48mo linear release</p>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 hover:border-green-500 transition-all duration-300 transform hover:-translate-y-2">
                    <h3 class="text-2xl font-semibold mb-4 text-green-300"><i class="fas fa-cogs mr-2"></i> Ecosystem</h3>
                    <p class="text-gray-400">15% (300M SPK)<br>DAO controlled</p>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 hover:border-yellow-500 transition-all duration-300 transform hover:-translate-y-2">
                    <h3 class="text-2xl font-semibold mb-4 text-yellow-300"><i class="fas fa-users mr-2"></i> Team & Dev</h3>
                    <p class="text-gray-400">10% (200M SPK)<br>12mo cliff, 24mo vesting</p>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 hover:border-red-500 transition-all duration-300 transform hover:-translate-y-2">
                    <h3 class="text-2xl font-semibold mb-4 text-red-300"><i class="fas fa-bullhorn mr-2"></i> Marketing</h3>
                    <p class="text-gray-400">8% (160M SPK)<br>25% TGE, 18mo linear</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Roadmap Section -->
    <section id="roadmap" class="py-20 px-4 bg-gray-950">
        <div class="max-w-6xl mx-auto text-center">
            <h2 class="text-4xl md:text-5xl font-bold mb-12 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-600">Roadmap</h2>
            <div class="roadmap">
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 mb-8 text-left">
                    <h3 class="text-2xl font-semibold mb-4 text-purple-300">Phase 1: Foundation & Launch (Q3–Q4 2025)</h3>
                    <ul class="list-disc list-inside text-gray-400 space-y-2 text-lg">
                        <li>Smart contract development and security audits</li>
                        <li>Token Generation Event and public launch</li>
                        <li>Initial DEX listing and liquidity provision</li>
                        <li>Launch official website and publish whitepaper</li>
                    </ul>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 mb-8 text-left">
                    <h3 class="text-2xl font-semibold mb-4 text-cyan-300">Phase 2: Ecosystem Expansion (Q1–Q3 2026)</h3>
                    <ul class="list-disc list-inside text-gray-400 space-y-2 text-lg">
                        <li>Launch SPK staking platform</li>
                        <li>DAO governance rollout</li>
                        <li>Strategic partnerships and integrations</li>
                        <li>Cross-chain bridge development</li>
                    </ul>
                </div>
                <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-left">
                    <h3 class="text-2xl font-semibold mb-4 text-pink-300">Phase 3: Mass Adoption (Q4 2026+)</h3>
                    <ul class="list-disc list-inside text-gray-400 space-y-2 text-lg">
                        <li>Advanced yield farming and liquidity mining</li>
                        <li>DEX integration and trading optimization</li>
                        <li>Tokenized real-world assets</li>
                        <li>Layer 2 integration and global outreach</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="p-6 bg-gray-950 border-t border-gray-800 text-center text-gray-500 rounded-t-xl z-10">
        <p class="mb-4">&copy; 2025 SPK Token. All rights reserved.</p>
        <div class="flex justify-center space-x-6 text-2xl">
            <a href="#" class="hover:text-purple-400 transition-colors duration-300">
                <img src="https://placehold.co/24x24/000000/FFFFFF?text=X" alt="Twitter" class="inline-block w-6 h-6 rounded-full" />
            </a>
            <a href="#" class="hover:text-purple-400 transition-colors duration-300">
                <img src="https://placehold.co/24x24/000000/FFFFFF?text=D" alt="Discord" class="inline-block w-6 h-6 rounded-full" />
            </a>
            <a href="#" class="hover:text-purple-400 transition-colors duration-300">
                <img src="https://placehold.co/24x24/000000/FFFFFF?text=T" alt="Telegram" class="inline-block w-6 h-6 rounded-full" />
            </a>
        </div>
    </footer>

    <script>
        // --- Custom Message Box Functionality ---
        const messageBox = document.getElementById('messageBox');
        let messageTimeout;

        function showMessage(message, type = 'success') {
            clearTimeout(messageTimeout);
            messageBox.innerHTML = `${type === 'success' ? '<i class="fas fa-check-circle mr-2"></i>' : type === 'error' ? '<i class="fas fa-exclamation-circle mr-2"></i>' : '<i class="fas fa-exclamation-triangle mr-2"></i>'} ${message}`;
            messageBox.className = `message-box ${type}`; // Apply type class
            messageBox.classList.remove('hidden');

            messageTimeout = setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Smart Contract Constants (Placeholders) ---
        const PRESALE_CONTRACT_ADDRESS = "EQA0o000000000000000000000000000000000000000000000000000000000000000"; // Example address
        const CONTRACT_ABI = [
            {
                "name": "contributePresale",
                "inputs": [],
                "outputs": [],
                "type": "function"
            }
        ];


        // --- TON Connect Configuration ---
        const tonConnectConfig = {
            manifestUrl: "https://splufik.vercel.app/tonconnect-manifest.json",
            buttonRootId: "ton-connect",
            chain: 'mainnet',
        };

        let tonConnectUI;
        let presaleClaimed = false;

        const contributeBtn = document.getElementById("contribute-btn");
        const claimPresaleTokensBtn = document.getElementById("claim-presale-tokens-btn");

        // --- Countdown Dates (Global Declarations) ---
        // Presale begins on June 16, 2025
        const presaleStartDate = new Date("2025-06-16T00:00:00Z");

        // Presale ends on June 17, 2026
        const presaleEndDate = new Date("2026-06-17T00:00:00Z");


        // Initialize TON Connect
        async function initTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: tonConnectConfig.manifestUrl,
                    buttonRootId: tonConnectConfig.buttonRootId,
                    language: 'en',
                    uiPreferences: {
                        theme: 'DARK',
                        colors: {
                            light: {
                                connectButton: {
                                    background: '#4F46E5',
                                    text: '#FFFFFF'
                                }
                            }
                        }
                    }
                });

                tonConnectUI.onStatusChange(wallet => {
                    const walletStatusElement = document.getElementById("wallet-status");
                    
                    if (wallet && wallet.account.address) {
                        const shortAddress = `${wallet.account.address.slice(0, 6)}...${wallet.account.address.slice(-4)}`;
                        walletStatusElement.textContent = `Connected: ${shortAddress}`;
                        walletStatusElement.classList.add('text-green-400');
                        walletStatusElement.classList.remove('text-gray-400');
                        
                        updateButtonStates();
                        showMessage('Wallet connected and ready!', 'success');

                    } else {
                        walletStatusElement.textContent = 'Not Connected';
                        walletStatusElement.classList.remove('text-green-400');
                        walletStatusElement.classList.add('text-gray-400');
                        
                        disableButtons();
                        showMessage('Wallet disconnected.', 'warning');
                    }
                });

                tonConnectUI.ready.then(() => {
                    if (tonConnectUI.connected) {
                        tonConnectUI.onStatusChange(tonConnectUI.wallet);
                    } else {
                        disableButtons();
                    }
                }).catch(error => {
                    console.error("Error during TON Connect UI ready state check:", error);
                    showMessage("Failed to initialize wallet connection. Please try refreshing.", 'error');
                });

            } catch (error) {
                console.error('TON Connect initialization failed:', error);
                showMessage('Failed to initialize wallet system. Please check console for details and try again later.', 'error');
            }
        }

        // A helper function to disable buttons and reset related UI elements when wallet is disconnected
        function disableButtons() {
            contributeBtn.disabled = true;
            contributeBtn.textContent = "Connect Wallet to Buy";
            claimPresaleTokensBtn.disabled = true;
            claimPresaleTokensBtn.textContent = "Connect Wallet to Claim Presale";
            document.getElementById("wallet-status").textContent = "Not Connected";
            updateButtonStates(); // Re-evaluate button states for display
        }


        // --- Master function to update all button states ---
        function updateButtonStates() {
            const now = new Date().getTime();
            const isWalletConnected = tonConnectUI && tonConnectUI.connected;
            const presaleHasStarted = now >= presaleStartDate.getTime();
            const presaleHasEnded = now >= presaleEndDate.getTime();

            // Presale Contribute Button Logic
            if (!isWalletConnected) {
                contributeBtn.disabled = true;
                contributeBtn.textContent = "Connect Wallet to Buy";
            } else if (!presaleHasStarted) {
                contributeBtn.disabled = true;
                contributeBtn.textContent = "Presale Not Started Yet";
            } else if (presaleHasEnded) {
                contributeBtn.disabled = true;
                contributeBtn.textContent = "Presale Ended";
            } else {
                contributeBtn.disabled = false;
                contributeBtn.textContent = "Buy SPK Tokens";
            }

            // Presale Claim Button Logic
            if (!isWalletConnected) {
                claimPresaleTokensBtn.disabled = true;
                claimPresaleTokensBtn.textContent = "Connect Wallet to Claim Presale";
            } else if (!presaleHasEnded) {
                claimPresaleTokensBtn.disabled = true;
                claimPresaleTokensBtn.textContent = "Claim Not Active Yet (Presale Ongoing)";
            } else if (presaleClaimed) { // Check if already claimed
                claimPresaleTokensBtn.disabled = true;
                claimPresaleTokensBtn.textContent = "Presale Tokens Claimed!";
            } else {
                claimPresaleTokensBtn.disabled = false;
                claimPresaleTokensBtn.textContent = "Claim Your Presale Tokens";
            }
        }

        // Initialize TON Connect and other initial UI updates when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            initTonConnect();
            updatePresaleCountdown(); // Initial call to update presale countdown
        });


        // --- Presale Countdown Timer Logic ---
        const presaleCountdownElement = document.getElementById('presale-countdown');
        const presaleDaysElement = document.getElementById('presale-days');
        const presaleHoursElement = document.getElementById('presale-hours');
        const presaleMinutesElement = document.getElementById('presale-minutes');
        const presaleSecondsElement = document.getElementById('presale-seconds');
        const presaleCountdownTitle = document.getElementById('presale-countdown-title'); // Get the title element


        function updatePresaleCountdown() {
            const now = new Date().getTime();
            let distance;
            let titleText = "";
            let timerExpired = false;

            if (now < presaleStartDate.getTime()) {
                // Presale has not started yet
                distance = presaleStartDate.getTime() - now;
                titleText = "Presale Starts In:";
            } else if (now >= presaleStartDate.getTime() && now < presaleEndDate.getTime()) {
                // Presale is ongoing
                distance = presaleEndDate.getTime() - now;
                titleText = "Presale Ends In:";
            } else {
                // Presale has ended
                distance = -1; // Indicate expired
                titleText = "Presale Has Ended!";
                timerExpired = true;
            }

            presaleCountdownTitle.textContent = titleText; // Update the title dynamically

            if (timerExpired) {
                clearInterval(presaleCountdownInterval);
                presaleCountdownElement.innerHTML = "<span class='text-red-500'>PRESALE HAS ENDED!</span>";
            } else {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                presaleDaysElement.textContent = String(days).padStart(2, '0');
                presaleHoursElement.textContent = String(hours).padStart(2, '0');
                presaleMinutesElement.textContent = String(minutes).padStart(2, '0');
                presaleSecondsElement.textContent = String(seconds).padStart(2, '0');
            }
            updateButtonStates(); // Update button states based on time
        }

        const presaleCountdownInterval = setInterval(updatePresaleCountdown, 1000);
        updatePresaleCountdown(); // Initial call


        // --- Presale Contribution Logic ---
        const usdtAmountInput = document.getElementById('usdtAmount');
        const spkTokenRateDisplay = document.getElementById('spk-token-rate');
        const presaleTransactionStatusDiv = document.getElementById('presale-transaction-status');
        const presaleTokenRate = 200;

        const contributeBtnNormalState = document.getElementById('contribute-btn-normal-state');
        const contributeBtnProcessingState = document.getElementById('contribute-btn-processing-state');


        usdtAmountInput.addEventListener('input', (e) => {
            let value = parseFloat(e.target.value);
            
            if (isNaN(value)) {
                spkTokenRateDisplay.textContent = `${presaleTokenRate} SPK`;
                return;
            }
            
            if (value < 10) {
                value = 10;
                e.target.value = 10;
            } else if (value > 1000) {
                value = 1000;
                e.target.value = 1000;
            }
            
            const tokenAmount = value * presaleTokenRate;
            spkTokenRateDisplay.textContent = `${tokenAmount.toLocaleString()} SPK`;
        });

        contributeBtn.addEventListener('click', async () => {
            if (!tonConnectUI || !tonConnectUI.connected) {
                showMessage('Please connect your wallet first to contribute.', 'error');
                return;
            }
            if (new Date().getTime() < presaleStartDate.getTime()) {
                showMessage('Presale has not started yet. Please wait.', 'warning');
                return;
            }
            if (new Date().getTime() >= presaleEndDate.getTime()) {
                showMessage('The presale has already ended.', 'error');
                return;
            }

            const amount = parseFloat(usdtAmountInput.value);
            if (isNaN(amount) || amount < 10 || amount > 1000) {
                showMessage('Please enter a valid amount between 10-1000 USDT.', 'error');
                return;
            }

            // Set button to processing state
            contributeBtnNormalState.classList.add('hidden');
            contributeBtnProcessingState.classList.remove('hidden');
            contributeBtn.disabled = true;
            presaleTransactionStatusDiv.innerHTML = '<div class="transaction-status status-warning"><i class="fas fa-hourglass-half mr-2"></i> Processing contribution...</div>';

            try {
                // Convert USDT amount to TON (assuming 1 TON = 2.5 USDT for demonstration, replace with real oracle if available)
                const tonEquivalent = amount / 2.5; // Example: 1 TON = 2.5 USDT
                const tonNano = (tonEquivalent * 1e9).toFixed(0);

                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 600, // 10 minutes from now
                    messages: [{
                        address: PRESALE_CONTRACT_ADDRESS, // Send to the presale smart contract
                        amount: tonNano,
                    }]
                };

                await tonConnectUI.sendTransaction(tx);
                
                presaleTransactionStatusDiv.innerHTML = `<div class="transaction-status status-success"><i class="fas fa-check-circle mr-2"></i> Sent ${tonEquivalent.toFixed(2)} TON to SPK presale contract! You received ${amount * presaleTokenRate} SPK.</div>`;
                showMessage(`Successfully contributed ${amount} USDT!`, 'success');
                usdtAmountInput.value = '';
                spkTokenRateDisplay.textContent = `${presaleTokenRate} SPK`;

            } catch (error) {
                console.error("Presale contribution failed:", error);
                presaleTransactionStatusDiv.innerHTML = `<div class="transaction-status status-error"><i class="fas fa-exclamation-circle mr-2"></i> Transaction cancelled or failed.</div>`;
                showMessage(`Contribution failed: ${error.message || 'Transaction cancelled or failed.'}`, 'error');
            } finally {
                // Ensure button state is reset regardless of success or failure
                contributeBtnNormalState.classList.remove('hidden');
                contributeBtnProcessingState.classList.add('hidden');
                contributeBtn.disabled = false;
                updateButtonStates(); // Ensure display reflects actual state after attempt
            }
        });

        // Presale Claim Button Logic
        claimPresaleTokensBtn.addEventListener('click', async () => {
            if (!tonConnectUI || !tonConnectUI.connected) {
                showMessage('Please connect your wallet to claim presale tokens.', 'error');
                return;
            }
            if (new Date().getTime() < presaleEndDate.getTime()) {
                showMessage('Presale claim is not yet active. Please wait until the presale ends.', 'warning');
                return;
            }
            if (presaleClaimed) {
                showMessage('You have already claimed your presale tokens.', 'warning');
                return;
            }

            const presaleClaimStatusDiv = document.getElementById('presale-claim-status');
            presaleClaimStatusDiv.textContent = "Processing Presale Token Claim... ";
            claimPresaleTokensBtn.disabled = true;
            claimPresaleTokensBtn.textContent = "Claiming...";

            try {
                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 600,
                    messages: [{
                        address: PRESALE_CONTRACT_ADDRESS,
                        amount: "5000000",
                    }]
                };
                await tonConnectUI.sendTransaction(tx);

                presaleClaimStatusDiv.textContent = "✅ Presale tokens claimed successfully!";
                claimPresaleTokensBtn.textContent = "Tokens Claimed!";
                showMessage('Presale tokens claimed successfully!', 'success');
                presaleClaimed = true;

            } catch (error) {
                console.error("Presale token claim failed:", error);
                presaleClaimStatusDiv.innerHTML = `<div class="transaction-status status-error"><i class="fas fa-exclamation-circle mr-2"></i> Claim failed: ${error.message || 'Transaction cancelled or failed.'}</div>`;
                showMessage(`Presale claim failed: ${error.message || 'Transaction cancelled or failed.'}`, 'error');
            } finally {
                if (presaleClaimStatusDiv.textContent.includes("claimed successfully!")) {
                    claimPresaleTokensBtn.disabled = true;
                } else {
                    claimPresaleTokensBtn.disabled = false;
                    claimPresaleTokensBtn.textContent = "Claim Presale Tokens";
                }
                updateButtonStates();
            }
        });


        // --- Three.js 3D Background Setup ---
        window.onload = function () {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-bg'), antialias: true, alpha: true });

            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            const geometries = [
                new THREE.TorusKnotGeometry(1, 0.4, 100, 16),
                new THREE.SphereGeometry(1, 32, 32),
                new THREE.BoxGeometry(1.5, 1.5, 1.5),
                new THREE.OctahedronGeometry(1.2)
            ];

            const materials = [
                new THREE.MeshStandardMaterial({ color: 0x9333ea, transparent: true, opacity: 0.6, roughness: 0.5, metalness: 0.8 }),
                new THREE.MeshStandardMaterial({ color: 0xec4899, transparent: true, opacity: 0.6, roughness: 0.5, metalness: 0.8 }),
                new THREE.MeshStandardMaterial({ color: 0x06b6d4, transparent: true, opacity: 0.6, roughness: 0.5, metalness: 0.8 }),
                new THREE.MeshStandardMaterial({ color: 0x6d28d9, transparent: true, opacity: 0.6, roughness: 0.5, metalness: 0.8 })
            ];

            const objects = [];
            for (let i = 0; i < 10; i++) {
                const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                const material = materials[Math.floor(Math.random() * materials.length)];
                const mesh = new THREE.Mesh(geometry, material);

                mesh.position.set(
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20 - 10
                );
                mesh.rotation.set(
                    Math.random() * Math.PI,
                    Math.random() * Math.PI,
                    Math.random() * Math.PI
                );
                mesh.scale.setScalar(0.5 + Math.random() * 1.5);
                scene.add(mesh);
                objects.push(mesh);
            }

            camera.position.z = 5;

            let mouseX = 0, mouseY = 0;
            let targetX = 0, targetY = 0;
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX - windowHalfX) * 0.001;
                mouseY = (event.clientY - windowHalfY) * 0.001;
            });

            function animate() {
                requestAnimationFrame(animate);

                targetX = mouseX * 0.5;
                targetY = mouseY * 0.5;

                camera.rotation.y += (targetX - camera.rotation.y) * 0.05;
                camera.rotation.x += (targetY - camera.rotation.x) * 0.05;

                objects.forEach(obj => {
                    obj.rotation.x += 0.001 + Math.random() * 0.001;
                    obj.rotation.y += 0.001 + Math.random() * 0.001;
                    obj.position.y += Math.sin(Date.now() * 0.0001 + obj.position.x) * 0.005;
                    obj.position.x += Math.cos(Date.now() * 0.0001 + obj.position.y) * 0.005;
                });

                renderer.render(scene, camera);
            }

            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };
    </script>
</body>
</html>
